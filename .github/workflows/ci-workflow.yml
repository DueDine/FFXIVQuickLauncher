name: Auto Build & Release

on:
  workflow_dispatch:

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-release:
    name: Build and Release
    runs-on: windows-2022
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Generate Release Tag
        id: generate-tag
        shell: pwsh
        run: |
          $tzId = "China Standard Time"
          $utcNow = [DateTime]::UtcNow
          $cstTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId($utcNow, $tzId)
          $datePart = $cstTime.ToString("yy-MM-dd")
          $tags = git tag --list "$datePart-*"
          
          $maxNumber = 0
          foreach ($tag in $tags) {
              $numberPart = $tag.Split('-')[-1]
              if ($numberPart -match '^\d{2}$') {
                  $currentNumber = [int]$numberPart
                  $maxNumber = [Math]::Max($maxNumber, $currentNumber)
              }
          }
          
          $nextNumber = $maxNumber + 1
          $newTag = "{0}-{1:D2}" -f $datePart, $nextNumber
          Write-Output "new_tag=$newTag" >> $env:GITHUB_OUTPUT

      - name: Create Git Tag
        uses: actions/github-script@v6
        with:
          script: |
            const newTag = '${{ steps.generate-tag.outputs.new_tag }}'
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${newTag}`,
              sha: context.sha
            })

      - name: Build Artifacts
        run: |
          git submodule update --init --recursive
          cd ./src/
          dotnet restore
          cd "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\"
          .\MSBuild.exe $Env:GITHUB_WORKSPACE\src\XIVLauncher.sln /t:Build /p:Configuration=Release

      - name: Generate Hashes File
        shell: pwsh
        run: |
          $buildDir = "$env:GITHUB_WORKSPACE/src/bin/win-x64"
          $hashScript = "$env:GITHUB_WORKSPACE/scripts/CreateHashList.ps1"
          
          # 执行哈希生成脚本
          & $hashScript -targetDir $buildDir
          
          # 验证文件生成
          if (-not (Test-Path "$buildDir/hashes.json")) {
              Write-Error "❌ hashes.json 生成失败"
              exit 1
          }
          
          # 创建制品目录
          New-Item -ItemType Directory -Path "$env:GITHUB_WORKSPACE/artifacts" -Force
          
          # 复制哈希文件
          Copy-Item -Path "$buildDir/hashes.json" -Destination "$env:GITHUB_WORKSPACE/artifacts/"
          Write-Output "✅ 哈希文件已生成并复制"

      - name: Package 7z Archive
        shell: pwsh
        run: |
          $buildDir = "$env:GITHUB_WORKSPACE/src/bin/win-x64"
          $artifactDir = "$env:GITHUB_WORKSPACE/artifacts"
          
          $filesToCompress = Get-ChildItem -Path $buildDir
          7z a -t7z -mx=9 "$artifactDir/latest.7z" $filesToCompress.FullName
          
          Write-Output "✅ 7z 压缩包已创建"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.generate-tag.outputs.new_tag }}
          name: "Release ${{ steps.generate-tag.outputs.new_tag }}"
          files: |
            artifacts/latest.7z
            artifacts/hashes.json
