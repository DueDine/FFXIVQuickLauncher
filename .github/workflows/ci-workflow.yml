name: Auto Build & Release

on:
  workflow_dispatch:

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-release:
    name: Build and Release
    runs-on: windows-2022
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Generate Release Tag
        id: generate-tag
        shell: pwsh
        run: |
          $tzId = "China Standard Time"
          $utcNow = [DateTime]::UtcNow
          $cstTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId($utcNow, $tzId)
          $datePart = $cstTime.ToString("yy-MM-dd")
          $tags = git tag --list "$datePart-*"
          
          $maxNumber = 0
          foreach ($tag in $tags) {
              $numberPart = $tag.Split('-')[-1]
              if ($numberPart -match '^\d{2}$') {
                  $currentNumber = [int]$numberPart
                  $maxNumber = [Math]::Max($maxNumber, $currentNumber)
              }
          }
          
          $nextNumber = $maxNumber + 1
          $newTag = "{0}-{1:D2}" -f $datePart, $nextNumber
          Write-Output "new_tag=$newTag" >> $env:GITHUB_OUTPUT

      - name: Create Git Tag
        uses: actions/github-script@v6
        with:
          script: |
            const newTag = '${{ steps.generate-tag.outputs.new_tag }}'
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${newTag}`,
              sha: context.sha
            })

      - name: Build Artifacts
        run: |
          git submodule update --init --recursive
          cd ./src/
          dotnet restore
          cd "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\"
          .\MSBuild.exe $Env:GITHUB_WORKSPACE\src\XIVLauncher.sln /t:Build /p:Configuration=Release

      - name: Generate Hashes File
        shell: pwsh
        run: |
          .\scripts\CreateHashList.ps1 ./src/bin/win-x64
          Copy-Item -Path ./src/bin/win-x64/hashes.json -Destination ./artifacts/

      - name: Package 7z Archive
        shell: pwsh
        run: |
          mkdir -p ./artifacts
          $buildFiles = Get-ChildItem -Path ./src/bin/win-x64
          7z a -t7z -mx=9 ./artifacts/latest.7z $buildFiles

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.generate-tag.outputs.new_tag }}
          name: "Release ${{ steps.generate-tag.outputs.new_tag }}"
          files: |
            ./artifacts/latest.7z
            ./artifacts/hashes.json
          draft: false
          prerelease: false
